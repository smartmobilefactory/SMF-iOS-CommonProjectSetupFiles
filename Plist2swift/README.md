# Plist2Swift

Plist2swift generates swift code from given plist files. It will gather keys that are common for all plist and generate a protocol out of them. Keys that are unique to a plist will be added as optionals and a default implementation will be provided in extensions.

#### Note

   - <mark>*configurationName*</mark> key has to be added to the plist
   - Date and Data are not (yet) supported

### TODO

- [ ] Nested Dictionary support
- [x] CLI arguments

### Important

When you update the code, please also recompile the binary, as it's used in some project in a build phase.

You can use the following commands to achieve this quickly:

```
$ swiftc -static-stdlib -Osize -o Plist2swift Plist2swift.swift 
$ strip Plist2swift
```

or use `$ sh build.sh` to generate the binary.


## Example
---

Given plist A and plist B, we can generate swift code like so:

`swift Plist2swift.swift -e Api A.plist B.plist`

Now let's take a look into the plists and the generated code.

Plist A:

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>configurationName</key>
	<string>Alpha</string>
	<key>privateKey</key>
	<string>fsfhor4hrbih13r938ryafsdofbo1urb1 balblala</string>
	<key>inAlpha</key>
	<string>This is only in Alpha</string>
	<key>shouldSign</key>
	<true/>
	<key>numberItem</key>
	<integer>123</integer>
	<key>dateItem</key>
	<date>2018-09-11T08:10:30Z</date>
	<key>anotherDict</key>
	<dict>
		<key>secretKey</key>
		<string>vnoethoiu3thoufhaksfbksefgb;eagb;oaghkdjfbna;e</string>
		<key>accessToken</key>
		<string>soivhawr;ovgubljkvbxcnzsbv.ksjbvkfjbv</string>
	</dict>
	<key>onlyinAlphaDict</key>
	<dict>
		<key>completelyPrivateKey</key>
		<string>aaaaaaaaaaaaaaaaaaaaaaaaaa</string>
	</dict>
	<key>alphaArray</key>
	<array>
		<string>Ala</string>
		<string>ma</string>
		<string>gruźlicę</string>
	</array>
</dict>
</plist>
```

Plist B:

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
	<key>configurationName</key>
	<string>Beta</string>
	<key>inBeta</key>
	<string>This string is not in Alpha, only in Beta</string>
	<key>privateKey</key>
	<string>fdfsfsgfdgeqwerwfredvzxcw</string>
	<key>shouldSign</key>
	<false/>
	<key>numberItem</key>
	<integer>456</integer>
	<key>dateItem</key>
	<date>2018-09-11T08:10:30Z</date>
	<key>anotherDict</key>
	<dict>
		<key>secretKey</key>
		<string>uwrhfiusdbfvjhdsvhgavcayrtwdcatydfawufgla</string>
		<key>accessToken</key>
		<string>ascgsduycgauwygfuicblzsivclaweucvgalwc</string>
	</dict>
</dict>
</plist>
```

Generated Swift Code:

```
//
// Generated by plist2swift - Swift code from plists generator
//
// Generated on: 2018-09-18 12:16:46 +0000
//

import Foundation

protocol AnotherDictProtocol {
	var secretKey: String { get }
	var accessToken: String { get }
}
protocol OnlyinAlphaDictProtocol {
	var completelyPrivateKey: String { get }
}
protocol ApiProtocol {
	// Common Keys
	var privateKey: String { get }
	var anotherDict: AnotherDictProtocol { get }
	var configurationName: String { get }
	var shouldSign: Bool { get }
	var numberItem: Int { get }
	var dateItem: String { get }
	// Optional Keys
	var alphaArray: Array<Any>? { get }
	var onlyinAlphaDict: OnlyinAlphaDictProtocol? { get }
	var inBeta: String? { get }
	var inAlpha: String? { get }
}


internal enum Api {
	case alpha
	internal struct Alpha {
	internal struct AnotherDict: AnotherDictProtocol {
		internal let secretKey: String = "vnoethoiu3thoufhaksfbksefgb;eagb;oaghkdjfbna;e"
		internal let accessToken: String = "soivhawr;ovgubljkvbxcnzsbv.ksjbvkfjbv"
	}
	internal let anotherDict: AnotherDictProtocol = AnotherDict()
	internal let shouldSign: Bool = true
	internal let numberItem: Int = 123
	internal let configurationName: String = "Alpha"
	internal let privateKey: String = "fsfhor4hrbih13r938ryafsdofbo1urb1 balblala"
	internal let dateItem: String = "2018-09-11 08:10:30 +0000"
	}
	case beta
	internal struct Beta {
	internal let shouldSign: Bool = false
	internal let numberItem: Int = 456
	internal let configurationName: String = "Beta"
	internal let privateKey: String = "fdfsfsgfdgeqwerwfredvzxcw"
	internal let dateItem: String = "2018-09-11 08:10:30 +0000"
	internal struct AnotherDict: AnotherDictProtocol {
		internal let secretKey: String = "uwrhfiusdbfvjhdsvhgavcayrtwdcatydfawufgla"
		internal let accessToken: String = "ascgsduycgauwygfuicblzsivclaweucvgalwc"
	}
	internal let anotherDict: AnotherDictProtocol = AnotherDict()
	}

	var configuration: ApiProtocol {
		switch self {
		case .alpha:
			return Alpha()
		case .beta:
			return Beta()
		}
	}
}

extension Api.Alpha: ApiProtocol {
	var alphaArray: Array<Any>? {
		return ["Ala", "ma", "gruźlicę"]
	}
	internal struct OnlyinAlphaDict: OnlyinAlphaDictProtocol {
		internal let completelyPrivateKey: String = "aaaaaaaaaaaaaaaaaaaaaaaaaa"
	}
	var onlyinAlphaDict: OnlyinAlphaDictProtocol? {
		return OnlyinAlphaDict()
	}
	var inBeta: String? {
		return nil
	}
	var inAlpha: String? {
		return "This is only in Alpha"
	}
}

extension Api.Beta: ApiProtocol {
	var alphaArray: Array<Any>? {
		return nil
	}
	var onlyinAlphaDict: OnlyinAlphaDictProtocol? {
		return nil
	}
	var inBeta: String? {
		return "This string is not in Alpha, only in Beta"
	}
	var inAlpha: String? {
		return nil
	}
}

```

### How to use the code

Let's print out a common key and two plist specific keys and see what happens

```
private func printConfig(config: Api) {
	let privateKey = config.configuration.privateKey
	let inAlpha = config.configuration.inAlpha
	let inBeta = config.configuration.inBeta
	let accessToken = config.configuration.anotherDict.accessToken
	let secretKey = config.configuration.anotherDict.secretKey
	let onlyAlphaDict = config.configuration.onlyinAlphaDict?.completelyPrivateKey
	print("\(config)\n\(privateKey)\n\(inAlpha)\n\(inBeta)\n\(secretKey)\n\(accessToken)\nCompletely Private \(onlyAlphaDict)")
}

printConfig(config: Api.alpha)
printConfig(config: Api.beta)

```

Returns:

```
alpha
fsfhor4hrbih13r938ryafsdofbo1urb1 balblala
Optional("This is only in Alpha")
nil
vnoethoiu3thoufhaksfbksefgb;eagb;oaghkdjfbna;e
soivhawr;ovgubljkvbxcnzsbv.ksjbvkfjbv
Completely Private Optional("aaaaaaaaaaaaaaaaaaaaaaaaaa")

beta
fdfsfsgfdgeqwerwfredvzxcw
nil
Optional("This string is not in Alpha, only in Beta")
uwrhfiusdbfvjhdsvhgavcayrtwdcatydfawufgla
ascgsduycgauwygfuicblzsivclaweucvgalwc
Completely Private nil
```


## Migration
---

1. [PList preparation](#plist-preparation)
2. [Generate swift files](#generate-swift-files)
3. [Clean up](#clean-up)

### PList preparation

- Make sure your PList top level is a dictionary
- Strings need to be properly escaped to be generated
- Dictionary names need to be unique 
- Add a new row with key **configurationName** (string value needs to be unique when combining multiple PLists)

```
<dict>
	...

	<key>configurationName</key>
	<string>EnumCaseName</string>

	<key>UniqueDictionaryKey</key>
	<dict>
		<key>ProperlyEscapedString</key>
		<String>{String: \"ABC\"}</String>
	</dict>

	...
</dict>
```

### Generate swift files

Call the PList2Swift script directly from a Xcode script phase or from a seperate bash script.

**If your target embeds app extensions:** To prevent cycling targets the Xcode phase script has to be placed in the target that is built last

bash script example:
```
"${SRCROOT}/Submodules/SMF-iOS-CommonProjectSetupFiles/Plist2swift/Plist2swift" -e EnumName -o "${SRCROOT}/../FileName.generated.swift" "${SRCROOT}/../A.plist" "${SRCROOT}/../B.plist"
```

**Workaround for Xcode 10’s parallel build system, see** https://github.com/mac-cain13/R.swift/issues/456#issuecomment-426344064

Add following code for every generated file to your Xcode script phase
```
echo "\n" > "${SRCROOT}/../FileName.ignore.swift"
```

And add the file paths in Input Files and OutputFiles

- For Input Files: ${SRCROOT}/../FileName.ignore.swift
- For Output Files: ${SRCROOT}/../FileName.generated.swift

Built the project to generate Swift files

### Clean up

After adding generated files and building successfully (files are not added to project automatically)
- Remove Member Targetmemberships from PLists
- Add generated .ignore.swift to .gitignore
